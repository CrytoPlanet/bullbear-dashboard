name: è·å–å¸‚åœºæ•°æ®

on:
  schedule:
    # Run every 12 hours (UTC 00:00 and 12:00)
    - cron: '0 */12 * * *'
  push:
    branches:
      - main
      - 'feat/**'  # Also trigger on feat branches for testing
  workflow_dispatch: # Allow manual trigger

jobs:
  fetch-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: å®‰è£…ä¾èµ–
        run: |
          cd backend
          pip install fastapi uvicorn requests python-dotenv pandas lxml html5lib cloudscraper yfinance

      - name: è·å–å¸‚åœºæ•°æ®
        env:
          CMC_API_KEY: ${{ secrets.CMC_API_KEY }}
          TAAPI_SECRET: ${{ secrets.TAAPI_SECRET }}
        run: |
          cd backend
          python scripts/fetch_and_save_data.py

      - name: Commit data files
        # Only commit on main branch, feat branches just test
        if: github.ref == 'refs/heads/main' || github.event_name == 'schedule'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add frontend/public/data/*.json
          git diff --staged --quiet || (git commit -m "Auto update market data [skip ci]" && git push)
      
      - name: Test mode (feat branch)
        # Show test results for feat branches
        if: startsWith(github.ref, 'refs/heads/feat/') && github.event_name != 'schedule'
        run: |
          echo "âœ… Data fetch test completed (feat branch mode, files not committed)"
          echo "ğŸ“¦ Data files generated successfully"
          echo "ğŸ’¡ Files will be committed when merged to main branch"

