name: è·å–å¸‚åœºæ•°æ®

on:
  schedule:
    # æ¯12å°æ—¶è¿è¡Œä¸€æ¬¡ (UTCæ—¶é—´ 00:00 å’Œ 12:00)
    - cron: '0 */12 * * *'
  push:
    branches:
      - main
      - 'feat/**'  # feat åˆ†æ”¯ä¹Ÿå¯ä»¥è§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  pull_request:
    branches:
      - main  # PR åˆ° main æ—¶ä¹Ÿè§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  fetch-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: å®‰è£…ä¾èµ–
        run: |
          cd backend
          pip install fastapi uvicorn requests python-dotenv pandas lxml html5lib cloudscraper yfinance

      - name: è·å–å¸‚åœºæ•°æ®
        env:
          CMC_API_KEY: ${{ secrets.CMC_API_KEY }}
          TAAPI_SECRET: ${{ secrets.TAAPI_SECRET }}
        run: |
          cd backend
          python scripts/fetch_and_save_data.py

      - name: æäº¤æ•°æ®æ–‡ä»¶
        # åªåœ¨é PR çš„æƒ…å†µä¸‹æäº¤ï¼ˆPR æ—¶åªæµ‹è¯•ï¼Œä¸æäº¤ï¼‰
        if: github.event_name != 'pull_request'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add frontend/public/data/*.json
          git diff --staged --quiet || (git commit -m "è‡ªåŠ¨æ›´æ–°å¸‚åœºæ•°æ® [skip ci]" && git push)
      
      - name: PR æµ‹è¯•æç¤º
        # åœ¨ PR æ—¶æ˜¾ç¤ºæµ‹è¯•ç»“æœ
        if: github.event_name == 'pull_request'
        run: |
          echo "âœ… æ•°æ®è·å–æµ‹è¯•å®Œæˆï¼ˆPR æ¨¡å¼ï¼Œæœªæäº¤æ–‡ä»¶ï¼‰"
          echo "ğŸ“¦ æ•°æ®æ–‡ä»¶å·²ç”Ÿæˆï¼Œå¯åœ¨æ„å»ºäº§ç‰©ä¸­æŸ¥çœ‹"

